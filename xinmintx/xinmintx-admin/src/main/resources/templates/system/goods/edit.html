<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('修改商品')"/>
    <th:block th:include="include :: summernote-css"/>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-goods-edit" th:object="${goods}">
        <input name="id" th:field="*{id}" type="hidden">
        <input id="firstCode" th:value="*{firstCode}" type="hidden">
        <input id="secondCode" th:value="*{typeId}" type="hidden">
        <input id="sourceId" th:value="*{relateId}" type="hidden">
        <input id="threeTypeId" th:value="*{threeTypeId}" type="hidden">
        <div class="col-md-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">提供者类型：</label>
                <div class="col-sm-9">
                    <select class="form-control" name="source" id="source" th:field="*{source}"
                            onchange="showMerchant()" disabled>
                        <option value="1">厂家</option>
                        <option value="2">商家</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">提供者：</label>
                <div class="col-sm-9">
                    <select class="form-control" name="relateId" id="relateId"></select>
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">商品分类：</label>
                <div class="col-sm-9">
                    <select class="form-control" name="parentId" id="parentId"></select>
                </div>
                <!--<div class="col-sm-3">-->
                <!--<select class="form-control" name="typeId" id="typeId" onchange="getThreeType()"></select>-->
                <!--</div>-->
                <!--<div class="col-sm-3">-->
                <!--<select class="form-control" name="threeType" id="threeType"></select>-->
                <!--</div>-->
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">今日精选：</label>
                <div class="col-sm-9">
                    <select class="form-control" name="choiceness" id="choiceness" th:field="*{choiceness}">
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">热销：</label>
                <div class="col-sm-9">
                    <select class="form-control" name="hotSale" id="hotSale" th:field="*{hotSale}">
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </div>
            </div>
        </div>
<!--        <div class="col-md-12">-->
<!--            <div class="form-group">-->
<!--                <label class="col-sm-3 control-label">预购：</label>-->
<!--                <div class="col-sm-9">-->
<!--                    <select class="form-control" name="preorder" id="preorder" th:field="*{preorder}">-->
<!--                        <option value="0">否</option>-->
<!--                        <option value="1">是</option>-->
<!--                    </select>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
        <div class="col-md-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">礼包：</label>
                <div class="col-sm-9">
                    <select class="form-control" name="giftBag" id="giftBag" th:field="*{giftBag}">
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">商品简称：</label>
            <div class="col-sm-9">
                <input id="goodsListName" name="goodsListName" th:field="*{goodsListName}" class="form-control"
                       type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">商品详情名称：</label>
            <div class="col-sm-9">
                <input id="goodsName" name="goodsName" th:field="*{goodsName}"  maxlength="27" class="form-control" type="text"
                       required>
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group">
                <label class="col-sm-3 control-label">是否上架：</label>
                <div class="col-sm-9">
                    <select class="form-control" name="status" id="status" th:field="*{status}">
                        <option value="1">上架</option>
                        <option value="0">下架</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">商品轮播图片：</label>
            <div class="col-sm-6">
                <input type="file" id="files" class="imgsl" multiple="multiple" accept="image/*" onchange="carousel()">
                <input type="hidden" id="turnsPhoto" name="turnsPhoto" th:value="*{turnsPhoto}">
            </div>
        </div>
        <div id="Photo" style="margin-left: 190px"></div>
        <div class="form-group">
            <label class="col-sm-3 control-label">划线价：</label>
            <div class="col-sm-9">
                <input id="linePrice" name="linePrice" th:field="*{linePrice}" class="form-control" type="text"
                       required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">售价：</label>
            <div class="col-sm-9">
                <input id="price" name="price" th:field="*{price}" class="form-control" type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">代理价：</label>
            <div class="col-sm-9">
                <input id="agencyPrice" name="agencyPrice" th:field="*{agencyPrice}" class="form-control" type="text"
                       required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">市场价：</label>
            <div class="col-sm-9">
                <input id="bazaarPrice" name="bazaarPrice" th:field="*{bazaarPrice}" class="form-control" type="text"
                       required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">采购价：</label>
            <div class="col-sm-9">
                <input id="procurementPrice" name="procurementPrice" th:field="*{procurementPrice}" class="form-control"
                       type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">初始销量：</label>
            <div class="col-sm-9">
                <input id="salesInitial" name="salesInitial" th:field="*{salesInitial}" class="form-control" type="text"
                       value="0">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">活动标题：</label>
            <div class="col-sm-9">
                <input id="activityTitle" name="activityTitle" th:field="*{activityTitle}" class="form-control"
                       type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">库存：</label>
            <div class="col-sm-9">
                <input id="stockNum" name="stockNum" th:field="*{stockNum}" class="form-control" type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">排序：</label>
            <div class="col-sm-9">
                <input id="sort" name="sort" th:field="*{sort}" class="form-control" type="text" required>
            </div>
        </div>
        <!--<div class="col-md-12">-->
        <!--<div class="form-group" onclick="addModel()">-->
        <!--<label class="col-sm-3 control-label">选择规格：</label>-->
        <!--<div class="col-sm-9">-->
        <!--<select class="form-control" name="speType" id="speType" th:field="*{speType}" required>-->
        <!--<option value="">&#45;&#45;请选择&#45;&#45;</option>-->
        <!--<option value="1">单规格</option>-->
        <!--<option value="2">多规格</option>-->
        <!--</select>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="form-group" id="divM">-->
        <!--<label class="col-sm-3 control-label">规格参数：</label>-->
        <!--<div class="col-sm-8" id="typeValue">-->
        <!--<input id='specName' name='specName' th:field="*{specName}" class='form-control' type='text'>-->
        <!--</div>-->
        <!--<label class="col-sm-3 control-label">规格属性：</label>-->
        <!--<div class="col-sm-8" id="specification">-->
        <!--&lt;!&ndash;<div style="border: 1px solid black">&ndash;&gt;-->
        <!--&lt;!&ndash;规格属性<input name="specValue" class="form-control" type="text">&ndash;&gt;-->
        <!--&lt;!&ndash;编号<input name="skuId" class="form-control" type="text">&ndash;&gt;-->
        <!--&lt;!&ndash;库存<input name="skuStockNum" class="form-control" type="text">&ndash;&gt;-->
        <!--&lt;!&ndash;价格<input name="skuPrice" class="form-control" type="text">&ndash;&gt;-->
        <!--&lt;!&ndash;图片<input class="form-control" type="file" accept="image/*" onchange="uploadPhoto(event)">&ndash;&gt;-->
        <!--&lt;!&ndash;<input name="skuPhoto" class="form-control" type="hidden" value="">&ndash;&gt;-->
        <!--&lt;!&ndash;</div>&ndash;&gt;-->
        <!--</div>-->
        <!--</div>-->
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-content no-padding">
                        <div class="summernote" id="summernote" th:utext="*{content}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="content" name="content" value="">
    </form>
</div>
<th:block th:include="include :: footer"/>
<th:block th:include="include :: summernote-js"/>
<script type="text/javascript">
    $(function () {
        showMerchant();
        getParent();
        type();
        addModel();
        getPhoto();
    });

    var prefix = ctx + "system/goods";
    $("#form-goods-edit").validate({
        focusCleanup: true
    });

    function submitHandler() {
        var content = $('.summernote').summernote('code');
        $("#content").val(content);
        if ($.validate.form()) {
            $.operate.save(prefix + "/edit", $('#form-goods-edit').serialize());
        }
    }

    function addModel() {
        var speType = $("#speType").val();
        if (speType === "1") {
            $("#divM").show();
        } else {
            $("#divM").hide();
        }
    }

    //一级分类
    function getParent() {
        $.ajax({
            url: "/system/goods/getParent",
            method: "post",
            contentType: "application/x-www-form-urlencoded",
            async: false,
            success: function (res) {
                var _html = "";
                var parentCode = $("#secondCode").val();
                for (var i = 0; i < res.length; i++) {
                    var id = res[i].id;
                    if (id == parentCode) {
                        _html += "<option selected='selected' value='" + res[i].id + "'>" + res[i].typeName + "</option>";
                    } else {
                        _html += "<option value='" + res[i].id + "'>" + res[i].typeName + "</option>";
                    }
                }
                $("#parentId").html(_html);
                // getSecond()
            }
        });
    }

    //二级分类
    function getSecond() {
        var parentCode = $("#parentId").val();
        $.ajax({
            url: "/system/goods/getParentId",
            method: "post",
            contentType: "application/x-www-form-urlencoded",
            data: {
                "parentCode": parentCode
            },
            dataType: 'json',
            success: function (res) {
                var _html = "";
                var secondCode = $("#firstCode").val();
                for (var i = 0; i < res.length; i++) {
                    if (res[i].id == secondCode) {
                        _html += "<option selected='selected' value='" + res[i].id + "'>" + res[i].typeName + "</option>";
                    } else {
                        _html += "<option value='" + res[i].id + "'>" + res[i].typeName + "</option>";
                    }
                }
                $("#typeId").html(_html);
                getThreeType();
            }
        });
    }

    //三级分类
    function getThreeType() {
        var typeId = $("#typeId").val();
        $.ajax({
            url: "/system/goods/getThreeType",
            method: "post",
            contentType: "application/x-www-form-urlencoded",
            data: {
                "typeId": typeId
            },
            dataType: 'json',
            success: function (res) {
                var _html = "";
                var threeTypeId = $("#secondCode").val();
                for (var i = 0; i < res.length; i++) {
                    if (res[i].id == threeTypeId) {
                        _html += "<option selected='selected' value='" + res[i].id + "'>" + res[i].typeName + "</option>";
                    } else {
                        _html += "<option value='" + res[i].id + "'>" + res[i].typeName + "</option>";
                    }
                }
                $("#threeType").html(_html);
            }
        });
    }

    //查询商户
    function showMerchant() {
        var source = $("#source").val();
        $.ajax({
            url: "/system/goods/getMerchantId",
            method: "post",
            contentType: "application/x-www-form-urlencoded",
            data: {
                "source": source
            },
            success: function (res) {
                var _html = "";
                var sourceId = $("#sourceId").val();
                for (var i = 0; i < res.length; i++) {
                    if (res[i].factoryId == sourceId) {
                        _html += "<option selected='selected' value='" + res[i].factoryId + "'>" + res[i].name + "</option>";
                    } else {
                        _html += "<option value='" + res[i].factoryId + "'>" + res[i].name + "</option>";
                    }
                }
                $("#relateId").html(_html);
            }
        });
    }


    function carousel() {
        var files = document.getElementById("files").files;
        var formData = new FormData();
        for (var i = 0; i < files.length; i++) {
            formData.append("file", files[i]);
        }
        $.ajax({
            url: "/system/goods/imageListUpload",
            data: formData,
            type: "POST",
            async: false,
            cache: false,
            contentType: false,
            processData: false,
            success: function (data) {
                var turnPhoto = data.filese.split("#");
                var photoId = data.photoIds.split("#");
                var _html = "";
                var photo = $("#turnsPhoto").val();
                for (var i = 0; i < turnPhoto.length; i++) {
                    _html += "<div>";
                    _html += "<img src='" + turnPhoto[i] + "' width='100px' height='100px'>";
                    _html += "<input type='hidden' value='" + photoId[i] + "'>";
                    _html += "<button type='button' onclick='deletePhoto(event)'>删除</button>";
                    _html += "</div>";
                    photo += ","+photoId[i];
                }
                $("#Photo").append(_html);
                $("#turnsPhoto").val(photo);
            }
        });
    };

    function getPhoto() {
        var photos = "[[${goods.turnsPhotoList}]]";
        var photo = photos.substr(1, photos.length - 2);
        var turnPhoto = photo.split(",");
        var photoIdList = $("#turnsPhoto").val();
        var photoId = photoIdList.split(",");
        for (var i = 0; i < turnPhoto.length; i++) {
            $("#Photo").append("<div><img src='" + turnPhoto[i] + "' width='100px' height='100px'><input type='hidden' value='" + photoId[i] + "'><button type='button' onclick='deletePhoto(event)'>删除</button></div>");
        }
    }

    function deletePhoto(event) {
        var photoId = event.target.parentNode.children[1].value
        var v = event.target.parentNode
        v.parentNode.removeChild(v);
        var photoIdList = $("#turnsPhoto").val();
        var photo = photoIdList.split(",");
        var p = "";
        for (var i = 0; i < photo.length; i++) {
            if (photo[i] !== photoId){
                p += photo[i]+",";
            }
        }
        p = p.substr(0,p.length-1);
        $("#turnsPhoto").val(p)
    }

    //富文本格式转换
    $('#summernote').summernote({
        callbacks: {
            onImageUpload: function (file) { //图片默认以二进制的形式存储到数据库，调用此方法将请求后台将图片存储到服务器，返回图片请求地址到前端
                //将图片放入Formdate对象中
                //‘picture'为后台获取的文件名，file[0]是要上传的文件
                for (var i = 0; i < file.length; i++) {
                    var formData = new FormData();
                    formData.append("file", file[i]);
                    $.ajax({
                        type: 'post',
                        url: '/system/goods/imageUpload',
                        cache: false,
                        data: formData,
                        processData: false,
                        contentType: false,
                        dataType: 'text', //请求成功后，后台返回图片访问地址字符串，故此以text格式获取，而不是json格式
                        success: function (picture) {
                            $('#summernote').summernote('insertImage', picture);
                        },
                        error: function () {
                            alert("上传失败");
                        }
                    });
                }
            }
        }
    });

    function type() {
        var id = $("#id").val();
        var typeId = $("#speType").val();
        if (typeId == 1) {
            $.ajax({
                url: "/system/goods/getType/" + id + "/" + typeId,
                type: "POST",
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function (data) {
                    if (data.length > 0) {
                        for (var i = 0; i < data.length; i++) {
                            $("#specification").append(
                                "<div style='border: 1px solid black'>" +
                                "规格属性<input name='specValue' class='form-control' type='text' value='" + data[i].specValue + "'>" +
                                "编号<input name='skuId' class='form-control' type='text' value='" + data[i].skuId + "'>" +
                                "重量<input name='goodsWeight' class='form-control' type='text' value='" + data[i].goodsWeight + "'>" +
                                "库存<input name='skuStockNum' class='form-control' type='text' value='" + data[i].stockNum + "'>" +
                                "价格<input name='skuPrice' class='form-control' type='text' value='" + data[i].skuPrice + "'>" +
                                "图片<input class='form-control' type='file' accept='image/*' onchange='uploadPhoto(event)'>" +
                                "<input name='skuPhoto' class='form-control' type='hidden' value=''>" +
                                "</div>"
                            )
                        }
                    }
                }
            });
        }
    }


    $(document).ready(function () {
        $('.summernote').summernote({
            lang: 'zh-CN'
        });
    });
    var edit = function () {
        $("#eg").addClass("no-padding");
        $('.click2edit').summernote({
            lang: 'zh-CN',
            focus: true
        });
    };
    var save = function () {
        $("#eg").removeClass("no-padding");
        var aHTML = $('.click2edit').summernote('code');
        $('.click2edit').summernote('destroy');
    };
</script>
</body>
</html>